# Readme for Running Benchmarks in LineFS Paper  <!-- omit in toc -->

- [1. Microbenchmarks (throughput and latency)](#1-microbenchmarks-throughput-and-latency)
- [2. LevelDB](#2-leveldb)
	- [2.1. Required package](#21-required-package)
	- [2.2. Build LevelDB](#22-build-leveldb)
	- [2.3. Run LevelDB](#23-run-leveldb)
- [3. Filebench](#3-filebench)
	- [3.1. Rebuild LineFS without `BATCH_MEMCPY_LIST` flag](#31-rebuild-linefs-without-batch_memcpy_list-flag)
	- [3.2. Build filebench](#32-build-filebench)
	- [3.3. Disable ASLR](#33-disable-aslr)
	- [3.4. Run filebench](#34-run-filebench)
	- [3.5. Known issues](#35-known-issues)

All the benchmarks run on Primary host machine unless otherwise specified.

## 1. Microbenchmarks (throughput and latency)

To run througput microbenchmark:

```shell
cd bench/micro
./run_all_linefs.sh
```

You can select which benchmark to run in the `run_all_linefs.sh` script.

To change benchmark options like I/O size and the file size, modify `bench/micro/scripts/run_iobench_lat.sh` for the latency benchmark and `bench/micro/scripts/run_iobench.sh` for the throughput benchmark.


## 2. LevelDB

### 2.1. Required package

Install [snappy](https://github.com/google/snappy) package.

```shell
git clone https://github.com/google/snappy.git
cd snappy
git submodule update --init     # if you download source code from github.
mkdir build
cd build
cmake -DBUILD_SHARED_LIBS=ON ../
make && sudo make install
```

### 2.2. Build LevelDB

* gcc 7 was used. (gcc 4.8 does not enable snappy compression.)

```shell
cd bench/leveldb
make -j`nproc`
```

### 2.3. Run LevelDB

``` shell
cd bench/leveldb/mlfs
./run_bench_histo.sh -t linefs 		# Run LineFS alone.
./run_bench_histo.sh -t linefs -c  	# Run LineFS with streamcluster.
./run_bench_histo.sh -t assise 		# Run Assise alone.
./run_bench_histo.sh -t assise -c  	# Run Assise with streamcluster.
```

> Sometimes, LevelDB run with `fillrandom` or `fillsync` workload hangs while printing a result histogram. You can run the workload again by changing `bench/leveldb/mlfs/run_bench_histo.sh`. For example,
>
>from
>
>```shell
> ...
> for WL in fillseq,readseq fillseq,readrandom fillseq,readhot fillseq fillrandom fillsync; do
> ...
>```
>
>to
>
>```shell
> ...
> for WL in fillrandom fillsync; do
> ...
>```
>

## 3. Filebench

### 3.1. Rebuild LineFS without `BATCH_MEMCPY_LIST` flag

Currently, filebench is not patched to utilize batching RPC requests to the kernel worker (ยง4, ยง5.2.4). Disable it by commenting out the lines that set `BATCH_MEMCPY_LIST` flag in `kernfs/Makefile` and `libfs/Makefile`.

### 3.2. Build filebench

>The distributed source code includes a modified `bench/filebench/Makefile.in` file for LibFS use. This file is automatically generated during the installation of filebench. (*Step 1* described in `bench/filebench/README`)
If you regenerate autotool scripts (*Step 1*) due to some reasons, e.g. an `aclocal` version mismatch after OS upgrade, `Makefile.in` will be overwritten. In this case, you have to manually apply the LineFS related modifications on the original `Makefile.in` to a new `Makefile.in` file. You can easily identify the lines by searching the keyword "mlfs" or "MLFS" in the original `Makefile.in` file.

The installation process is as below. Refer to `bench/filebench/README` file for details.

```shell
cd bench/filebench
cp Makefile.in Makefile.in.old  # Backup original file.
libtoolize
aclocal
autoheader
automake --add-missing
autoconf

./configure
make  # Without -j option.
```

### 3.3. Disable ASLR

Disabling ASLR is required.
Related issue: [link](https://github.com/filebench/filebench/issues/112)

```shell
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```

### 3.4. Run filebench

The following commands run filebench experiments.

```shell
cd bench/filebench
./run_all.sh -t nic  # Run with LineFS
./run_all.sh -t nic -c  # Run with LineFS and a cpu-intensive job.
./run_all.sh -t hostonly # Run with Assise
./run_all.sh -t hostonly -c # Run with Assise and a cpu-intensive job.
```

> If you want to run `fileserver` or `varmail` workload individually, use the scripts `run_fileserver.sh` and `run_varmail.sh`.

### 3.5. Known issues

- Filebench hangs at the end of the execution.
  - Printed message:

    ```shell
    ...
    [worker] shutting down mlfs
    ```

  - Workaround: Exit the program (`sudo pkill -9 filebench`). It doesn't affect the experiment results.
