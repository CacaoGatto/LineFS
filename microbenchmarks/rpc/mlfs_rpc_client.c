/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */
#include <time.h>
#include <sys/time.h>
#include "mlfs_rpc.h"

#ifndef _TIMER_SUB_H_
#define _TIMER_SUB_H_
#ifndef timersub
#define timersub(a, b, result)                                                \
  do {                                                                        \
 (result)->tv_sec = (a)->tv_sec - (b)->tv_sec;                             \
 (result)->tv_usec = (a)->tv_usec - (b)->tv_usec;                          \
 if ((result)->tv_usec < 0) {                                              \
   --(result)->tv_sec;                                                     \
   (result)->tv_usec += 1000000;                                           \
 }                                                                         \
  } while (0)
#endif
#ifndef timeradd
#define timeradd(a, b, result)                                                \
  do {                                                                        \
 (result)->tv_sec = (a)->tv_sec + (b)->tv_sec;                             \
 (result)->tv_usec = (a)->tv_usec + (b)->tv_usec;                          \
 if ((result)->tv_usec >= 1000000)                                         \
   {                                                                       \
     ++(result)->tv_sec;                                                   \
     (result)->tv_usec -= 1000000;                                         \
   }                                                                       \
  } while (0)
#endif
#endif


int
main (int argc, char *argv[])
{   
	if (argc < 2) {
		printf ("usage: %s io_size\n", argv[0]);
		return 1;
	}

    CLIENT *clnt;
	int  *result_1;
	mlfs_write_io mlfs_rpc_write_1_arg;

	unsigned int io_size = atoi(argv[1]);
    char host[] = "127.0.0.1";

    /*
     * Set up client
     */
    clnt = clnt_create (host, MLFS_RPC, MLFS_RPC_VER, "udp");
	if (clnt == NULL) {
		clnt_pcreateerror (host);
		return 1;
	}
    
    //init io buffer
    mlfs_rpc_write_1_arg.n = io_size;
    mlfs_rpc_write_1_arg.data = malloc(io_size);
    for (int i = 0 ; i < io_size ; i++) mlfs_rpc_write_1_arg.data[i] = i%255;
    mlfs_rpc_write_1_arg.type = 0;

    /*
     * Start timer
     */
    struct timeval start, end;
    gettimeofday(&start, NULL);

    /*
     *  Call the RPC writes
     */
    int mb = 1024*1024;
    io_size *= mb;
    int total_write = (512*mb);
    int total_ios = total_write/io_size;
    for (int i = 0 ; i < total_ios ; i++) {
        result_1 = mlfs_rpc_write_1(&mlfs_rpc_write_1_arg, clnt);
    	if (result_1 == (int *) NULL) {
    		clnt_perror (clnt, "call failed");
    	}
    }

    /*
     *  Stop timer
     */
    gettimeofday(&end, NULL);
    struct timeval t_elap;
    timersub(&end,&start,&t_elap);
    float sec = (float)(t_elap.tv_sec * 1000000.0 + (float)t_elap.tv_usec) / 1000000.0;


    printf("io %d MB  throughput %.2f\n", io_size, total_write/sec);


    //cleanup
    clnt_destroy (clnt);

    return 0;
}
